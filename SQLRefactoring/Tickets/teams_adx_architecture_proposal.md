# ADX Architecture Proposal - SENSOR_SNAPSHOT_GET Migration

## ğŸ“Š Discovery Summary

Following up on the CR2_MILL performance analysis, here are our findings:

### Stress Test Results (20 iterations)

| Version | Min | Max | Mean | Median |
|---------|-----|-----|------|--------|
| **Baseline (Snowflake)** | 18.3s | 45.9s | 30.1s | 29.5s |
| **Refactor (Snowflake)** | 10.6s | 42.1s | 21.0s | 20.6s |
| **ADX Direct** | 0.13s | 0.31s | **0.15s** | 0.14s |

### Performance Comparison

| Comparison | Speedup |
|------------|---------|
| Refactor vs Baseline | **1.4x faster** |
| ADX vs Baseline | **~200x faster** |
| ADX vs Refactor | **~150x faster** |

### Why ADX is Faster

1. **No UNION ALL** - Snowflake scans 7 tables (~52 GB), ADX queries 1 database directly
2. **Columnar + Time-Series Optimized** - ADX is built for telemetry/sensor data
3. **Pre-materialized Snapshots** - `FCTSCURRENT` already has latest values per sensor
4. **Native Caching** - Hot data stays in memory

---

## ğŸ—ï¸ Proposed Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CURRENT STATE vs PROPOSED STATE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€ CURRENT (Slow) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                  â”‚   â”‚
â”‚  â”‚   IoT Sensors                                                                    â”‚   â”‚
â”‚  â”‚       â”‚                                                                          â”‚   â”‚
â”‚  â”‚       â–¼                                                                          â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚   â”‚ Event Hubâ”‚â”€â”€â”€â–ºâ”‚ Snowflake (SENSOR_READING_*_B tables)        â”‚              â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   - SENSOR_READING_SAM_B (~7 GB)             â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - SENSOR_READING_MOR_B (~7 GB)             â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - SENSOR_READING_CMX_B (~7 GB)             â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - ... (7 tables total ~52 GB)              â”‚              â”‚   â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                      â”‚                                          â”‚   â”‚
â”‚  â”‚                                      â–¼                                          â”‚   â”‚
â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚                   â”‚ SENSOR_SNAPSHOT_GET (Table Function)         â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - UNION ALL of 7 tables                    â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - Full scan every query                    â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - ~20-40 seconds per call                  â”‚              â”‚   â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                      â”‚                                          â”‚   â”‚
â”‚  â”‚                                      â–¼                                          â”‚   â”‚
â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚                   â”‚ CR2_MILL (View) â†’ API                        â”‚              â”‚   â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€ PROPOSED (Fast) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                  â”‚   â”‚
â”‚  â”‚   IoT Sensors                                                                    â”‚   â”‚
â”‚  â”‚       â”‚                                                                          â”‚   â”‚
â”‚  â”‚       â–¼                                                                          â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚   â”‚ Event Hubâ”‚â”€â”€â”€â–ºâ”‚ Azure Data Explorer (ADX)                    â”‚              â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   Cluster: fctsnaproddatexp02.westus2        â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚                                               â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   Databases (by site):                        â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   â”œâ”€â”€ Miami      (SAM) â†’ FCTSCURRENT         â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   â”œâ”€â”€ Morenci    (MOR) â†’ FCTSCURRENT         â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   â”œâ”€â”€ Climax     (CMX) â†’ FCTSCURRENT         â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   â”œâ”€â”€ Sierrita   (SIE) â†’ FCTSCURRENT         â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   â”œâ”€â”€ NewMexico  (NMO) â†’ FCTSCURRENT         â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   â”œâ”€â”€ Bagdad     (BAG) â†’ FCTSCURRENT         â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   â””â”€â”€ CerroVerde (CVE) â†’ FCTSCURRENT         â”‚              â”‚   â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                      â”‚ ~0.15 seconds                            â”‚   â”‚
â”‚  â”‚                                      â–¼                                          â”‚   â”‚
â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚                   â”‚ Azure Function (Direct KQL Query)            â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - No Snowflake hop                         â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - Site-specific database                   â”‚              â”‚   â”‚
â”‚  â”‚                   â”‚   - Sub-second response                      â”‚              â”‚   â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                      â”‚                                          â”‚   â”‚
â”‚  â”‚                                      â–¼                                          â”‚   â”‚
â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚                   â”‚ Power BI / API / Dashboard                   â”‚              â”‚   â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Technical Implementation Details

### Option A: Azure Function with ADX SDK (Recommended for new APIs)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AZURE FUNCTION â†’ ADX DIRECT                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  HTTP Request â”‚     â”‚  Azure Function (Python/C#)                              â”‚    â”‚
â”‚   â”‚               â”‚     â”‚                                                          â”‚    â”‚
â”‚   â”‚  POST /api/   â”‚     â”‚  from azure.kusto.data import KustoClient               â”‚    â”‚
â”‚   â”‚  sensor/      â”‚â”€â”€â”€â”€â–ºâ”‚  from azure.identity import DefaultAzureCredential      â”‚    â”‚
â”‚   â”‚  snapshot     â”‚     â”‚                                                          â”‚    â”‚
â”‚   â”‚               â”‚     â”‚  def sensor_snapshot(site_code, sensors):               â”‚    â”‚
â”‚   â”‚  {            â”‚     â”‚      db = SITE_MAP[site_code]  # "MOR" â†’ "Morenci"      â”‚    â”‚
â”‚   â”‚    "site":    â”‚     â”‚      kql = f'''                                         â”‚    â”‚
â”‚   â”‚      "MOR",   â”‚     â”‚          database('{db}').FCTSCURRENT                   â”‚    â”‚
â”‚   â”‚    "sensors": â”‚     â”‚          | where sensor_id in ({sensors})               â”‚    â”‚
â”‚   â”‚      [...]    â”‚     â”‚          | project TAG_NAME=sensor_id, ...              â”‚    â”‚
â”‚   â”‚  }            â”‚     â”‚      '''                                                 â”‚    â”‚
â”‚   â”‚               â”‚     â”‚      return client.execute(db, kql)                      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                â”‚                                        â”‚
â”‚                                                â–¼                                        â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                         â”‚  ADX Cluster                                  â”‚               â”‚
â”‚                         â”‚  fctsnaproddatexp02.westus2.kusto.windows.netâ”‚               â”‚
â”‚                         â”‚                                               â”‚               â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚               â”‚
â”‚                         â”‚  â”‚  Morenci    â”‚  â”‚  Miami      â”‚  ...       â”‚               â”‚
â”‚                         â”‚  â”‚  FCTSCURRENTâ”‚  â”‚  FCTSCURRENTâ”‚            â”‚               â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚               â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                                         â”‚
â”‚   Response Time: ~150ms (vs 30s Snowflake)                                             â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Option B: Hybrid (ADX â†’ SQL Azure â†’ Snowflake) for Existing Pipelines

For pipelines like **LOAD_HAUL__LH_BUCKET** that already use SQL Azure + Snowflake:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HYBRID: ADX + SQL Azure + Snowflake                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  REAL-TIME LAYER (ADX) - Sensor/Telemetry Data                                  â”‚  â”‚
â”‚   â”‚                                                                                  â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚  â”‚  ADX Cluster: fctsnaproddatexp02.westus2.kusto.windows.net               â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                           â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  Use for:                                                                 â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ SENSOR_SNAPSHOT_GET (CR2_MILL, real-time sensors)                     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ Any PI/OPC tag queries                                                 â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ Time-series analytics                                                  â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                           â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  Response: <1 second                                                      â”‚   â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  OPERATIONAL LAYER (SQL Azure) - API Serving + Staging                          â”‚  â”‚
â”‚   â”‚                                                                                  â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚  â”‚  SQL Azure Servers:                                                       â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  DEV:  azwd22midbx02.eb8a77f2eea6.database.windows.net                   â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  TEST: azwt22midbx02.9959d3e6fe6e.database.windows.net                   â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  PROD: azwp22midbx02.8232c56adfdf.database.windows.net                   â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                           â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  Databases:                                                               â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”œâ”€â”€ ConnectedOperations (CONOPS views, UPSERT procedures)               â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â””â”€â”€ SNOWFLAKE_WG (DRILL_CYCLE_IMO, staging tables)                      â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                           â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  Use for:                                                                 â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ API serving (low-latency reads)                                        â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ MERGE staging (_IMO table types)                                       â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ Application data (Logbook, Maintenance Calendar)                       â”‚   â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  ANALYTICS LAYER (Snowflake) - Warehouse + Historical                           â”‚  â”‚
â”‚   â”‚                                                                                  â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚  â”‚  Snowflake Account                                                        â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                           â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  DEV_API_REF.FUSE (Current work)                                    â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚                                                                      â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  LOAD_HAUL Objects:                                                  â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â”œâ”€â”€ LH_BUCKET_INCR (table)                                         â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â”œâ”€â”€ LH_BUCKET_INCR_P (MERGE procedure)                             â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â”œâ”€â”€ LH_BUCKET_INCR_T (task, */15 * * * * UTC)                      â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â”œâ”€â”€ LH_LOADING_CYCLE_INCR (table)                                  â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â”œâ”€â”€ LH_LOADING_CYCLE_INCR_P (MERGE procedure)                      â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â””â”€â”€ LH_LOADING_CYCLE_INCR_T (task, */15 * * * * UTC)               â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚                                                                      â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  DRILL_BLAST Objects:                                                â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â”œâ”€â”€ DRILLBLAST_DRILL_CYCLE_INCR (table)                            â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â”œâ”€â”€ DRILLBLAST_DRILL_CYCLE_INCR_P (MERGE procedure)                â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  â””â”€â”€ DRILLBLAST_DRILL_CYCLE_INCR_TASK (suspended)                   â”‚ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                           â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  Source Views (PROD_WG):                                                  â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”œâ”€â”€ PROD_WG.LOAD_HAUL.LH_BUCKET                                         â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”œâ”€â”€ PROD_WG.LOAD_HAUL.LH_LOADING_CYCLE                                  â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â””â”€â”€ PROD_WG.DRILL_BLAST.DRILLBLAST_DRILL_CYCLE_V                        â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                           â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  Use for:                                                                 â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ Historical analytics                                                   â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ Data warehousing                                                       â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ Complex aggregations                                                   â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  âœ“ Cross-domain joins                                                     â”‚   â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow: LOAD_HAUL Pipeline (Current)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOAD_HAUL__LH_BUCKET PIPELINE                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   Step 1: Source Data (Snowflake Views)                                                â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                               â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  PROD_WG.LOAD_HAUL.LH_BUCKET (VIEW)                                             â”‚  â”‚
â”‚   â”‚  PROD_WG.LOAD_HAUL.LH_LOADING_CYCLE (VIEW)                                      â”‚  â”‚
â”‚   â”‚                                                                                  â”‚  â”‚
â”‚   â”‚  These views aggregate data from underlying tables with business logic          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                                  â”‚
â”‚                                      â–¼ (Every 15 minutes)                              â”‚
â”‚                                                                                         â”‚
â”‚   Step 2: Incremental Load (Snowflake Tasks)                                           â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                           â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  DEV_API_REF.FUSE.LH_BUCKET_INCR_T                                              â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚   â”‚  â”‚  CALL DEV_API_REF.FUSE.LH_BUCKET_INCR_P()                               â”‚    â”‚  â”‚
â”‚   â”‚  â”‚                                                                          â”‚    â”‚  â”‚
â”‚   â”‚  â”‚  -- Inside the procedure:                                                â”‚    â”‚  â”‚
â”‚   â”‚  â”‚  MERGE INTO LH_BUCKET_INCR AS target                                     â”‚    â”‚  â”‚
â”‚   â”‚  â”‚  USING (                                                                 â”‚    â”‚  â”‚
â”‚   â”‚  â”‚      SELECT * FROM PROD_WG.LOAD_HAUL.LH_BUCKET                          â”‚    â”‚  â”‚
â”‚   â”‚  â”‚      WHERE SRC_UPDATE_DT >= :last_run                                   â”‚    â”‚  â”‚
â”‚   â”‚  â”‚  ) AS source                                                             â”‚    â”‚  â”‚
â”‚   â”‚  â”‚  ON target.BUCKET_KEY = source.BUCKET_KEY                               â”‚    â”‚  â”‚
â”‚   â”‚  â”‚  WHEN MATCHED THEN UPDATE ...                                            â”‚    â”‚  â”‚
â”‚   â”‚  â”‚  WHEN NOT MATCHED THEN INSERT ...                                        â”‚    â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                                  â”‚
â”‚                                      â–¼                                                  â”‚
â”‚                                                                                         â”‚
â”‚   Step 3: Target Table (Snowflake)                                                     â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                    â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  DEV_API_REF.FUSE.LH_BUCKET_INCR                                                â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ Current rows: 54,436                                                       â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ Primary Key: BUCKET_KEY                                                    â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ Incremental column: SRC_UPDATE_DT                                          â”‚  â”‚
â”‚   â”‚  â””â”€â”€ Updated every 15 min via task                                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                                  â”‚
â”‚                                      â–¼ (Azure Function triggers)                       â”‚
â”‚                                                                                         â”‚
â”‚   Step 4: Sync to SQL Azure (Future - via Azure Function)                              â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                              â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Azure Function: fusesflksqlnatestfctapp01                                      â”‚  â”‚
â”‚   â”‚                                                                                  â”‚  â”‚
â”‚   â”‚  1. Query Snowflake for changed rows                                            â”‚  â”‚
â”‚   â”‚  2. Build TVP (Table-Valued Parameter) with LOAD_HAUL__LH_BUCKET_IMO type       â”‚  â”‚
â”‚   â”‚  3. Call MERGE procedure in SQL Azure                                           â”‚  â”‚
â”‚   â”‚  4. Log result                                                                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                                  â”‚
â”‚                                      â–¼                                                  â”‚
â”‚                                                                                         â”‚
â”‚   Step 5: SQL Azure (API Serving)                                                      â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                      â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  ConnectedOperations Database                                                    â”‚  â”‚
â”‚   â”‚                                                                                  â”‚  â”‚
â”‚   â”‚  Table Type: [dbo].[LOAD_HAUL__LH_BUCKET_IMO]                                   â”‚  â”‚
â”‚   â”‚  MERGE Proc:  [dbo].[UPSERT_CONOPS_LH_BUCKET] (to be created)                   â”‚  â”‚
â”‚   â”‚  View:        [dbo].[CONOPS_LH_BUCKET_V] (for API consumption)                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ ADX Connection Details

### Cluster Information

| Property | Value |
|----------|-------|
| **Cluster URL** | `https://fctsnaproddatexp02.westus2.kusto.windows.net` |
| **Note** | Use `02` not `01` (per HÃ©ctor) |
| **Authentication** | Azure AD / Managed Identity |

### Database to Site Mapping

| Site Code | ADX Database | Snowflake Table |
|-----------|--------------|-----------------|
| SAM | Miami | SENSOR_READING_SAM_B |
| MOR | Morenci | SENSOR_READING_MOR_B |
| CMX | Climax | SENSOR_READING_CMX_B |
| SIE | Sierrita | SENSOR_READING_SIE_B |
| NMO | NewMexico | SENSOR_READING_NMO_B |
| BAG | Bagdad | SENSOR_READING_BAG_B |
| CVE | CerroVerde | SENSOR_READING_CVE_B |

### KQL Query Template

```kql
// SENSOR_SNAPSHOT_GET equivalent
let sensor_list = dynamic([
    'CR03_CRUSH_OUT_TIME',
    'PE_MOR_CC_MflPileTonnage',
    'PE_MOR_CC_MillPileTonnage'
]);
database('Morenci').FCTSCURRENT
| where sensor_id in (sensor_list)
| project
    TAG_NAME = sensor_id,
    VALUE_UTC_TS = timestamp,
    SENSOR_VALUE = tostring(value),
    UOM = uom,
    QUALITY = quality
```

---

## âœ… Current Status

| Object | Status | Location |
|--------|--------|----------|
| LH_BUCKET_INCR | âœ… Deployed | DEV_API_REF.FUSE |
| LH_BUCKET_INCR_P | âœ… Deployed | DEV_API_REF.FUSE |
| LH_BUCKET_INCR_T | âœ… Running (*/15 min) | DEV_API_REF.FUSE |
| LH_LOADING_CYCLE_INCR | âœ… Deployed | DEV_API_REF.FUSE |
| LH_LOADING_CYCLE_INCR_P | âœ… Deployed | DEV_API_REF.FUSE |
| LH_LOADING_CYCLE_INCR_T | âœ… Running (*/15 min) | DEV_API_REF.FUSE |
| DRILLBLAST_DRILL_CYCLE_INCR | âœ… Deployed | DEV_API_REF.FUSE |
| DRILL_BLAST__DRILL_CYCLE_IMO | âœ… Created | SQL Azure DEV |
| SENSOR_SNAPSHOT_GET (ADX) | âœ… Template ready | adx_function.kql |

---

## ğŸ¯ Recommendations

### For SENSOR_SNAPSHOT_GET / CR2_MILL:
1. **Migrate API to query ADX directly** - 200x faster
2. **Create Azure Function endpoint** that calls ADX
3. **Deprecate Snowflake function** once API is updated

### For LOAD_HAUL / DRILL_BLAST:
1. **Keep current Snowflake â†’ SQL Azure pipeline** 
2. **These are not real-time** - 15-minute refresh is acceptable
3. **Complete Azure Function integration** per PR #86

### Decision Matrix:

| Data Type | Best Source | Reason |
|-----------|-------------|--------|
| Real-time sensors | **ADX** | Sub-second response, native time-series |
| Operational data (Load/Haul) | **Snowflake â†’ SQL** | Business logic in views, batch OK |
| Historical analytics | **Snowflake** | Complex joins, aggregations |
| API serving | **SQL Azure** | Low latency, geo-redundancy |

---

## ğŸ“ Attachments

- [adx_function.kql](./adx_function.kql) - ADX function template
- [adx_equivalent.kql](../QUERIES/PROD_API_REF__CONNECTED_OPERATIONS__SENSOR_SNAPSHOT_GET/adx_equivalent.kql) - Full examples
- [stress_test.py](../QUERIES/PROD_API_REF__CONNECTED_OPERATIONS__SENSOR_SNAPSHOT_GET/stress_test.py) - Benchmark script

---

**Questions?** Let me know if you need more details on any of these components.

@Uttam, Vikas @M, Hidayath @Khatter, Rohit
