# =============================================================================
# ADX UNIFIED SEMANTIC MODEL - WITH BUSINESS KPI MAPPING
# =============================================================================
# Single reference for all ADX databases in the FCTS cluster
# Cluster: fctsnaproddatexp02.westus2.kusto.windows.net
#
# Use this as the primary reference for understanding ADX data architecture
# INCLUDES: Business KPI mappings from knowledge_base.json
# =============================================================================

semantic_model:
  name: ADX_FCTS_Unified
  description: |
    Unified semantic model for all FCTS Azure Data Explorer databases.
    This is the primary real-time sensor data platform replacing Snowflake SENSOR_READING_* tables.
    
    INCLUDES BUSINESS KPI MAPPING:
    - Mill IOS (HIGHEST PRIORITY) â†’ ADX Available
    - Mill Crusher Rate â†’ ADX Available
    - Processing Metrics â†’ ADX Available
    - Drilling/Blasting â†’ Snowflake Only
    - Load/Haul â†’ Partial (SAP Integration)
    
  cluster: https://fctsnaproddatexp02.westus2.kusto.windows.net
  version: "2.0.0"
  updated_at: "2026-01-22"
  knowledge_base_ref: "../knowledge_base.json"

# =============================================================================
# ðŸŽ¯ BUSINESS KPI TO ADX MAPPING
# =============================================================================
# Maps business requirements from knowledge_base.json to ADX data sources
# Priority: HIGHEST â†’ HIGH â†’ MEDIUM â†’ LOWER

business_kpis:
  
  # ===================== MILL IOS - HIGHEST PRIORITY =====================
  mill_ios:
    priority: HIGHEST
    business_description: |
      Current level of In-Ore Stockpile + direction of change.
      This is the MOST CRITICAL metric - design focuses on this!
    adx_availability: FULLY_AVAILABLE
    confidence: 100%
    
    kpis:
      main_ios_level:
        pi_tag: "MOR-CC06_LI00601_PV"
        description: "Main IOS Level - Primary stockpile indicator"
        adx_database: Morenci
        adx_source: "database('Morenci').FCTS"
        kql_filter: "sensor_id =~ 'MOR-CC06_LI00601_PV'"
        target_uom: "%"
        
      small_ios_level:
        pi_tag: "MOR-CC10_LI0102_PV"
        description: "Small IOS Level - Secondary stockpile"
        adx_database: Morenci
        adx_source: "database('Morenci').FCTS"
        kql_filter: "sensor_id =~ 'MOR-CC10_LI0102_PV'"
        target_uom: "%"
        
    recommended_kql: |
      // Mill IOS Level with Direction of Change
      let lookback = 1h;
      database("Morenci").FCTS
      | where sensor_id in~ ("MOR-CC06_LI00601_PV", "MOR-CC10_LI0102_PV")
      | where timestamp > ago(lookback)
      | order by sensor_id, timestamp asc
      | extend prev_value = prev(toreal(value), 1), prev_sensor = prev(sensor_id, 1)
      | where sensor_id == prev_sensor
      | summarize arg_max(timestamp, value, prev_value) by sensor_id
      | extend 
          current_level = toreal(value),
          direction = case(
              toreal(value) > toreal(prev_value), "â†‘ INCREASING",
              toreal(value) < toreal(prev_value), "â†“ DECREASING",
              "â†’ STABLE")
      | project sensor_id, current_level, direction, timestamp
      
  # ===================== MILL CRUSHER RATE - HIGH PRIORITY =====================
  mill_crusher:
    priority: HIGH
    business_description: "Crusher throughput rate monitoring"
    adx_availability: FULLY_AVAILABLE
    confidence: 100%
    
    kpis:
      crusher_3_rate:
        pi_tag: "MOR-CR03_WI00317_PV"
        description: "Mill Crusher #3 Rate"
        adx_database: Morenci
        adx_source: "database('Morenci').FCTS"
        kql_filter: "sensor_id =~ 'MOR-CR03_WI00317_PV'"
        target_min: 8500
        target_max: 9000
        target_uom: "tph"
        
      crushed_leach_rate:
        pi_tag: "MOR-CR02_WI01203_PV"
        description: "Crushed Leach Rate"
        adx_database: Morenci
        adx_source: "database('Morenci').FCTS"
        kql_filter: "sensor_id =~ 'MOR-CR02_WI01203_PV'"
        target_min: 4500
        target_max: 6000
        target_uom: "tph"
        
    recommended_kql: |
      // Mill Crusher Rates with Target Comparison
      database("Morenci").FCTSCURRENT()
      | where sensor_id in~ ("MOR-CR03_WI00317_PV", "MOR-CR02_WI01203_PV")
      | extend 
          metric = case(
              sensor_id =~ "MOR-CR03_WI00317_PV", "Mill Crusher Rate",
              "Crushed Leach Rate"),
          target_min = iff(sensor_id =~ "MOR-CR03_WI00317_PV", 8500.0, 4500.0),
          target_max = iff(sensor_id =~ "MOR-CR03_WI00317_PV", 9000.0, 6000.0)
      | extend 
          current_value = toreal(value),
          status = case(
              toreal(value) >= target_min and toreal(value) <= target_max, "âœ… ON TARGET",
              toreal(value) < target_min, "âš ï¸ BELOW TARGET",
              "ðŸ”´ ABOVE TARGET")
      | project metric, current_value, target_min, target_max, status, timestamp

  # ===================== PROCESSING - MEDIUM PRIORITY =====================
  processing:
    priority: MEDIUM
    business_description: "Ball mill and concentrator operations"
    adx_availability: MOSTLY_AVAILABLE
    confidence: 95%
    
    kpis:
      ball_mill_tph:
        pi_tag_pattern: "MOR-WIC01XX_PV"
        description: "Ball Mill TPH (32 mills, sections 1-4)"
        adx_database: Morenci
        adx_source: "database('AppIntegration').Morenci_Batman_BallMill_Aggregates()"
        note: "Pre-built function returns all 32 ball mills"
        
      mill_power:
        pi_tag_pattern: "MOR-JIC32XX_PV"
        description: "Mill Power readings per ball mill"
        adx_database: Morenci
        adx_source: "database('AppIntegration').Morenci_Batman_BallMill_Aggregates()"
        
      classifier_ph:
        pi_tag_pattern: "MOR-AIC91XX_PV"
        description: "Classifier pH per ball mill"
        adx_database: Morenci
        adx_source: "database('AppIntegration').Morenci_Batman_BallMill_Aggregates()"
        
      bin_levels:
        pi_tag_pattern: "MOR-MS01_LIC215XX_PV"
        description: "Ore bin levels"
        adx_database: Morenci
        adx_source: "database('AppIntegration').Morenci_Batman_Mill_Overview()"
        
    recommended_kql: |
      // Ball Mill Aggregates - All sections
      database("AppIntegration").Morenci_Batman_BallMill_Aggregates()
      | project section, ballmill, tph_now, tpoh_now, mill_power, classifier_amps, classifier_ph

  # ===================== DRILLING - LOWER PRIORITY =====================
  drilling:
    priority: LOWER
    business_description: "Drill cycle metrics and penetration rates"
    adx_availability: NOT_AVAILABLE
    confidence: 0%
    current_source: "Snowflake PROD_WG.DRILL_BLAST.DRILL_CYCLE"
    
    kpis:
      penetration_rate:
        column: "AVG_PNTRTN_RATE_FEET_PER_MIN"
        description: "Average penetration rate"
        adx_available: false
        snowflake_table: "PROD_WG.DRILL_BLAST.DRILL_CYCLE"
        migration_path: "Fleet dispatch integration required"
        target_range: "Variable by rock type"
        
      drill_cycle_time:
        column: "DRILL_CYCLE_HRS_CYCLE"
        description: "Total drill cycle time"
        adx_available: false
        snowflake_table: "PROD_WG.DRILL_BLAST.DRILL_CYCLE"
        
      weight_on_bit:
        column: "WEIGHT_ON_BIT_RANGE_LBS"
        description: "Weight on bit for drilling"
        adx_available: false
        snowflake_table: "PROD_WG.DRILL_BLAST.DRILL_CYCLE"
        target_min: 50000
        target_max: 70000
        target_uom: "lbs"
        
    reason_not_in_adx: |
      Drilling data comes from fleet dispatch systems (Modular, Wenco, etc.)
      and equipment telematics, not continuous sensor data.
      Would require new IoT sensors or fleet integration to ADX.

  # ===================== BLASTING - LOWER PRIORITY =====================
  blasting:
    priority: LOWER
    business_description: "Blast patterns and explosives tracking"
    adx_availability: NOT_AVAILABLE
    confidence: 0%
    current_source: "Snowflake PROD_WG.DRILL_BLAST"
    
    kpis:
      lbs_on_ground:
        description: "Explosives inventory on ground"
        adx_available: false
        snowflake_table: "PROD_WG.DRILL_BLAST"
        
      powder_factor:
        description: "Powder factor calculation"
        adx_available: false
        snowflake_table: "Calculated metric"
        
    reason_not_in_adx: |
      Blasting is event-based, not continuous sensor data.
      Data sources: Blast design software, manual entry, compliance systems.

  # ===================== LOADING - LOWER PRIORITY =====================
  loading:
    priority: LOWER
    business_description: "Shovel/LHD loading operations"
    adx_availability: PARTIAL
    confidence: 70%
    
    kpis:
      equipment_hours:
        description: "Equipment operating hours"
        adx_available: true
        adx_source: "database('AppIntegration').HaulTruck()"
        note: "Via SAP integration"
        
      tons_loaded:
        description: "Tons loaded per cycle"
        adx_available: false
        current_source: "Dispatch system"
        
    recommended_kql: |
      // Equipment telemetry from SAP
      database("AppIntegration").HaulTruck()
      | project SAPEquipmentID, SAPMeasurementID, timestamp, value, uom
      | where SAPMeasurementID contains "Hours"

  # ===================== HAULAGE - LOWER PRIORITY =====================
  haulage:
    priority: LOWER
    business_description: "Haul truck cycle and fuel metrics"
    adx_availability: PARTIAL
    confidence: 60%
    
    kpis:
      fuel_consumption:
        description: "Fuel consumption per truck"
        adx_available: true
        adx_source: "database('AppIntegration').HaulTruck()"
        kql_filter: "SAPMeasurementID contains 'Fuel'"
        
      cycle_time:
        description: "Haul cycle time"
        adx_available: false
        current_source: "Dispatch system"
        target_max: 25
        target_uom: "minutes"
        
      dump_compliance:
        description: "Dump location compliance"
        adx_available: false
        current_source: "Dispatch system"
        
    recommended_kql: |
      // Haul truck fuel from SAP
      database("AppIntegration").HaulTruck()
      | where SAPMeasurementID contains "Fuel Consumption"
      | project SAPEquipmentID, timestamp, value = round(value, 2), uom

# =============================================================================
# KPI AVAILABILITY SUMMARY MATRIX
# =============================================================================

kpi_availability_matrix:
  - {value_chain: "Mill IOS", kpi: "Main IOS Level", pi_tag: "MOR-CC06_LI00601_PV", adx: true, confidence: "100%"}
  - {value_chain: "Mill IOS", kpi: "Small IOS Level", pi_tag: "MOR-CC10_LI0102_PV", adx: true, confidence: "100%"}
  - {value_chain: "Mill Crusher", kpi: "Crusher #3 Rate", pi_tag: "MOR-CR03_WI00317_PV", adx: true, confidence: "100%"}
  - {value_chain: "Mill Crusher", kpi: "Crushed Leach Rate", pi_tag: "MOR-CR02_WI01203_PV", adx: true, confidence: "100%"}
  - {value_chain: "Processing", kpi: "Ball Mill TPH", pi_tag: "MOR-WIC01XX_PV", adx: true, confidence: "100%"}
  - {value_chain: "Processing", kpi: "Mill Power", pi_tag: "MOR-JIC32XX_PV", adx: true, confidence: "100%"}
  - {value_chain: "Processing", kpi: "Classifier pH", pi_tag: "MOR-AIC91XX_PV", adx: true, confidence: "100%"}
  - {value_chain: "Processing", kpi: "Bin Levels", pi_tag: "MOR-MS01_LIC215XX_PV", adx: true, confidence: "100%"}
  - {value_chain: "Drilling", kpi: "Penetration Rate", column: "AVG_PNTRTN_RATE", adx: false, snowflake: "PROD_WG.DRILL_BLAST"}
  - {value_chain: "Drilling", kpi: "Drill Cycle Time", column: "DRILL_CYCLE_HRS", adx: false, snowflake: "PROD_WG.DRILL_BLAST"}
  - {value_chain: "Blasting", kpi: "LBS on Ground", column: "N/A", adx: false, snowflake: "PROD_WG.DRILL_BLAST"}
  - {value_chain: "Loading", kpi: "Equipment Hours", sap: true, adx: true, confidence: "70%"}
  - {value_chain: "Haulage", kpi: "Fuel Consumption", sap: true, adx: true, confidence: "90%"}
  - {value_chain: "Haulage", kpi: "Cycle Time", dispatch: true, adx: false}
  
# =============================================================================
# SITE DATABASES
# =============================================================================
# All site databases share the SAME schema pattern:
#   - Table: FCTS_INGEST (raw ingestion)
#   - Function: FCTS (historical data with retention)
#   - Function: FCTSCURRENT (latest snapshot per sensor)

site_databases:
  - name: Miami
    site_code: SAM
    description: Miami site sensor data
    snowflake_equivalent: PROD_DATALAKE.FCTS.SENSOR_READING_SAM_B
    
  - name: Morenci
    site_code: MOR
    description: Morenci site sensor data
    snowflake_equivalent: PROD_DATALAKE.FCTS.SENSOR_READING_MOR_B
    approximate_row_count: 493000000
    
  - name: Climax
    site_code: CMX
    description: Climax site sensor data
    snowflake_equivalent: PROD_DATALAKE.FCTS.SENSOR_READING_CMX_B
    
  - name: Sierrita
    site_code: SIE
    description: Sierrita site sensor data
    snowflake_equivalent: PROD_DATALAKE.FCTS.SENSOR_READING_SIE_B
    
  - name: NewMexico
    site_code: NMO
    description: New Mexico site sensor data
    snowflake_equivalent: PROD_DATALAKE.FCTS.SENSOR_READING_NMO_B
    
  - name: Bagdad
    site_code: BAG
    description: Bagdad site sensor data
    snowflake_equivalent: PROD_DATALAKE.FCTS.SENSOR_READING_BAG_B
    
  - name: CerroVerde
    site_code: CVE
    description: Cerro Verde site sensor data
    snowflake_equivalent: PROD_DATALAKE.FCTS.SENSOR_READING_CVE_B

# =============================================================================
# COMMON SCHEMA (applies to ALL site databases)
# =============================================================================

common_entities:
  FCTS_INGEST:
    description: |
      Raw sensor data ingestion table. Data streams directly from Event Hub.
      Use FCTS or FCTSCURRENT functions for querying - they add retention policies.
    type: table
    columns:
      - name: site_code
        type: string
        description: Site identifier (MOR, BAG, SAM, etc.)
        
      - name: sensor_id
        type: string
        description: Unique sensor identifier / PI Point name
        is_primary_key: true
        examples:
          - "mor-cr03_wi00317_pv"
          - "BLNKPNTRCHR_OPC.SMOHYD.PI_SLP_RATE"
          
      - name: data_source
        type: string
        description: Source system identifier
        
      - name: timestamp
        type: datetime
        description: Reading timestamp (UTC)
        is_temporal: true
        
      - name: value
        type: string
        description: Sensor reading value (as string, may need casting)
        is_measure: true
        
      - name: uom
        type: string
        description: Unit of measure
        
      - name: quality
        type: int
        description: Data quality indicator (0 = good)
        
      - name: annotations
        type: dynamic
        description: Additional metadata as JSON
        
      - name: stream_details
        type: dynamic
        description: Stream configuration details as JSON
        
      - name: enqueuedtime
        type: datetime
        description: Event Hub ingestion timestamp
        
  FCTS:
    description: |
      Historical sensor data function with retention policy.
      Use for time-series analysis and historical queries.
    type: function
    returns: Sensor readings with retention
    usage: |
      database('Morenci').FCTS
      | where timestamp > ago(30d)
      | where sensor_id == "sensor_name"
    output_columns:
      - site_code
      - sensor_id
      - data_source
      - timestamp
      - value
      - uom
      - quality
      
  FCTSCURRENT:
    description: |
      Latest snapshot per sensor. Most efficient for current values.
      Equivalent to Snowflake SENSOR_SNAPSHOT_GET function.
    type: function
    returns: One row per sensor with latest value
    usage: |
      database('Morenci').FCTSCURRENT
      | where sensor_id in ("sensor1", "sensor2")
    output_columns:
      - sensor_id
      - timestamp
      - value
      - uom
      - quality

# =============================================================================
# GLOBAL DATABASE (Metadata & Registry)
# =============================================================================

global_database:
  name: Global
  description: Central registry, metadata, and cross-site functions
  
  tables:
    FaeLogsIngest:
      description: FAE (Factory Automation Engine) job execution logs
      approximate_row_count: 442000000
      columns:
        - {name: id, type: guid, is_primary_key: true}
        - {name: siteCode, type: string}
        - {name: jobId, type: guid}
        - {name: name, type: string}
        - {name: scheduled, type: datetime}
        - {name: start, type: datetime}
        - {name: end, type: datetime}
        - {name: status, type: string}
        - {name: errors, type: bool}
        - {name: actionLogs, type: dynamic}
        
    RegistryIngest:
      description: Sensor/device registry with metadata
      columns:
        - {name: id, type: string, is_primary_key: true}
        - {name: registryType, type: string}
        - {name: displayName, type: string}
        - {name: siteCode, type: string}
        - {name: process, type: string}
        - {name: version, type: int}
        - {name: status, type: string}
        - {name: deviceType, type: string}
        - {name: dataModel, type: string}
        - {name: sensors, type: dynamic}
        
    JobsIngest:
      description: FAE job definitions and schedules
      columns:
        - {name: id, type: guid, is_primary_key: true}
        - {name: name, type: string}
        - {name: siteCode, type: string}
        - {name: schedule, type: string}
        - {name: enabled, type: bool}
        
  functions:
    # Cross-site sensor functions
    FCTS_CURRENT_VALUE:
      description: Get current value for any sensor across sites
      parameters: [site_code, sensor_id]
      
    RegistryStreams:
      description: List all registered sensor streams
      
    RegistryDevices:
      description: List all registered devices
      
    RegistryConstants:
      description: Configuration constants
      
    # ConSmelter functions (Cerro Verde Smelter)
    ConSmelter:
      description: Smelter operations functions for Cerro Verde
      functions:
        - GetCopperAssay
        - GetCopperAssayByTotalBatchId
        - GetCopperBlowProtocolExecution
        - GetFlashFurnaceStatus
        - GetFlashFurnaceTHRate
        - GetHalfTimeKpi
        - GetHalfTimeKpi_Chip
        - GetHalfTimeKpi_CrushedMaterial
        - GetHalfTimeKpi_Silica
        - GetMaterialInputTons
        - GetRefiningBurnerMinMax
        - GetRefiningNaturalGasRatio
        - GetRefiningTuyereAirFlow
        - GetRefiningTuyereGasFlow
        - GetRefiningTuyere1AirFlow
        - GetRefiningTuyere1GasFlow
        - GetRefiningTuyere2AirFlow
        - GetRefiningTuyere2GasFlow
        - GetSlagBlowProtocolExecutionFirstHalf
        - GetSlagBlowProtocolExecutionSecondHalf
        - GetSlagCopperBlowAvgFlowRate
        - GetSO2Peaks
        - GetOperationalParametersFollowUps
        - GetCastingLadleHeating
        - GetCastingSpeed
        - GetCastingTaskDefaultValueByStartEnd
        - GetUpperBottomTempPreparation
        - GetFlashFurnaceMatteAssayManualReader
        - GetFlashFurnaceTargetAssay
        - GetPisDefaultValue
        
    # MillOps functions (Mill Operations KPIs)
    MillOps:
      description: Mill operations KPI functions
      functions:
        - GetKpisValue
        - GetKpiDetailValue
        - GetKpisColumnNpsWater
        - GetKpisRougherRecovery
        - GetKpisCanyonRecycle
        - GetKpis5010Densinometer
        - GetKpis5011Densinometer
        
    # PI System Integration
    PISystem:
      description: Direct PI System data access
      functions:
        - PISystem_MOR_Raw_Data
        - PISystem_MOR_Daily_Averages
        - PISystem_NMO_Raw_Data
        - PISystem_NMO_Daily_Averages
        
    # FAE Job Monitoring
    FaeJobs:
      description: FAE job monitoring functions
      functions:
        - FaeJobLog
        - FaeJobsStatus
        - FaeRunIDLog
        - FaeUi_GetRecentJobLogs
        - FaeUi_GetJobInvocationLog
        
    # Utility functions
    Utilities:
      functions:
        - GetDynamicHierarchy
        - PI_Integration_DataSources
        - time_weighted_avg_fl
        - TimeEq
        - UDETripLogs
        - AllUDETripLogs

# =============================================================================
# APP INTEGRATION DATABASE
# =============================================================================

app_integration_database:
  name: AppIntegration
  description: Application-specific integration functions for dashboards and APIs
  
  functions:
    AcidTankLevels:
      description: Acid tank level monitoring for all sites
      usage: database('AppIntegration').AcidTankLevels()
      
    HaulTruck:
      description: Haul truck telemetry data
      usage: database('AppIntegration').HaulTruck()
      
    HaulTruck_DEV:
      description: Development version of HaulTruck function
      
    Morenci_Batman:
      description: Morenci Batman mill monitoring
      functions:
        - Morenci_Batman_BallMill_Aggregates
        - Morenci_Batman_Section_Aggregates
        - Morenci_Batman_Mill_Overview

# =============================================================================
# QUERY PATTERNS
# =============================================================================

query_patterns:
  # Get current value for specific sensors at a site
  current_value_single_site:
    description: Get latest sensor values from a specific site
    kql: |
      database('Morenci').FCTSCURRENT
      | where sensor_id in ("sensor1", "sensor2", "sensor3")
      | project TAG_NAME = sensor_id, VALUE_UTC_TS = timestamp, 
                SENSOR_VALUE = tostring(value), UOM = uom, QUALITY = quality
                
  # Historical time-series query
  historical_timeseries:
    description: Get sensor history for time-series analysis
    kql: |
      database('Morenci').FCTS
      | where timestamp > ago(24h)
      | where sensor_id == "mor-cr03_wi00317_pv"
      | summarize avg(todouble(value)) by bin(timestamp, 5m)
      
  # Cross-site comparison
  cross_site_current:
    description: Compare current values across multiple sites
    kql: |
      union
        (database('Morenci').FCTSCURRENT | extend site = "MOR"),
        (database('Bagdad').FCTSCURRENT | extend site = "BAG"),
        (database('Miami').FCTSCURRENT | extend site = "SAM")
      | where sensor_id contains "CRUSHER"
      | project site, sensor_id, timestamp, value
      
  # Aggregated statistics
  daily_statistics:
    description: Calculate daily statistics for a sensor
    kql: |
      database('Morenci').FCTS
      | where timestamp > ago(7d)
      | where sensor_id == "sensor_name"
      | summarize 
          avg_value = avg(todouble(value)),
          min_value = min(todouble(value)),
          max_value = max(todouble(value)),
          reading_count = count()
        by bin(timestamp, 1d)

# =============================================================================
# SNOWFLAKE TO ADX MIGRATION MAPPING
# =============================================================================

migration_mapping:
  description: |
    Mapping from Snowflake SENSOR_READING tables to ADX databases.
    The SENSOR_READING_*_B tables in Snowflake are being deprecated.
    
  mappings:
    - snowflake: PROD_DATALAKE.FCTS.SENSOR_READING_MOR_B
      adx_database: Morenci
      adx_function: FCTS / FCTSCURRENT
      
    - snowflake: PROD_DATALAKE.FCTS.SENSOR_READING_BAG_B
      adx_database: Bagdad
      adx_function: FCTS / FCTSCURRENT
      
    - snowflake: PROD_DATALAKE.FCTS.SENSOR_READING_SAM_B
      adx_database: Miami
      adx_function: FCTS / FCTSCURRENT
      
    - snowflake: PROD_DATALAKE.FCTS.SENSOR_READING_CMX_B
      adx_database: Climax
      adx_function: FCTS / FCTSCURRENT
      
    - snowflake: PROD_DATALAKE.FCTS.SENSOR_READING_SIE_B
      adx_database: Sierrita
      adx_function: FCTS / FCTSCURRENT
      
    - snowflake: PROD_DATALAKE.FCTS.SENSOR_READING_NMO_B
      adx_database: NewMexico
      adx_function: FCTS / FCTSCURRENT
      
    - snowflake: PROD_DATALAKE.FCTS.SENSOR_READING_CVE_B
      adx_database: CerroVerde
      adx_function: FCTS / FCTSCURRENT
      
  snowflake_function_equivalent:
    function: PROD_API_REF.CONNECTED_OPERATIONS.SENSOR_SNAPSHOT_GET
    adx_equivalent: database('{site_db}').FCTSCURRENT
    performance_improvement: "~200x faster"

# =============================================================================
# MEASURES (Standard Aggregations)
# =============================================================================

measures:
  - name: current_value
    description: Latest sensor reading
    expression: FCTSCURRENT | summarize Value=take_any(value) by sensor_id
    
  - name: avg_24h
    description: 24-hour rolling average
    expression: FCTS | where timestamp > ago(24h) | summarize avg(todouble(value)) by sensor_id
    
  - name: max_24h
    description: 24-hour maximum
    expression: FCTS | where timestamp > ago(24h) | summarize max(todouble(value)) by sensor_id
    
  - name: min_24h
    description: 24-hour minimum
    expression: FCTS | where timestamp > ago(24h) | summarize min(todouble(value)) by sensor_id
    
  - name: reading_count_24h
    description: Number of readings in last 24 hours
    expression: FCTS | where timestamp > ago(24h) | summarize count() by sensor_id
    
  - name: data_freshness
    description: Time since last reading
    expression: FCTSCURRENT | extend freshness = now() - timestamp | project sensor_id, freshness

# =============================================================================
# DIMENSIONS
# =============================================================================

dimensions:
  - name: site
    description: Mining site
    values: [MOR, BAG, SAM, CMX, SIE, NMO, CVE]
    
  - name: sensor_id
    description: Unique PI Point / sensor identifier
    
  - name: timestamp
    description: Reading time (UTC)
    time_grains: [second, minute, hour, day, week, month]
    
  - name: quality
    description: Data quality code (0 = good)
    
  - name: uom
    description: Unit of measure

# =============================================================================
# CONNECTION INFO
# =============================================================================

connection:
  cluster: https://fctsnaproddatexp02.westus2.kusto.windows.net
  authentication: Azure AD (Interactive Browser / Service Principal)
  required_packages:
    - azure-kusto-data
    - azure-identity
  security_group: SG-ENT-FCTS-ADX-Viewer
  
  python_example: |
    from azure.identity import InteractiveBrowserCredential
    from azure.kusto.data import KustoClient, KustoConnectionStringBuilder
    
    cluster = "https://fctsnaproddatexp02.westus2.kusto.windows.net"
    credential = InteractiveBrowserCredential()
    kcsb = KustoConnectionStringBuilder.with_azure_token_credential(cluster, credential)
    client = KustoClient(kcsb)
    
    # Query example
    result = client.execute("Morenci", "FCTSCURRENT | take 10")

# =============================================================================
# RECOMMENDED ADX FUNCTIONS TO CREATE
# =============================================================================
# These functions should be created in the Global or AppIntegration database
# to support the business KPIs defined in knowledge_base.json

recommended_functions:

  MillIOS_Current:
    priority: HIGHEST
    description: "Returns current IOS levels with trend direction"
    target_database: Global
    parameters: "(site_code:string = 'MOR')"
    kql_body: |
      // Function: MillIOS_Current
      // Returns: Current IOS levels with trend direction
      let ios_sensors = dynamic(["MOR-CC06_LI00601_PV", "MOR-CC10_LI0102_PV"]);
      database("Morenci").FCTS
      | where sensor_id in~ (ios_sensors)
      | where timestamp > ago(2h)
      | order by sensor_id, timestamp asc
      | serialize 
      | extend prev_value = prev(value, 1), prev_sensor = prev(sensor_id, 1)
      | where sensor_id == prev_sensor or isnull(prev_sensor)
      | summarize arg_max(timestamp, value, prev_value) by sensor_id
      | extend 
          current = toreal(value),
          previous = toreal(prev_value),
          direction = case(
              toreal(value) > toreal(prev_value), "INCREASING",
              toreal(value) < toreal(prev_value), "DECREASING",
              "STABLE")
      | project sensor_id, level = current, direction, timestamp
      
  MillCrusher_Current:
    priority: HIGH
    description: "Returns crusher rates with target status"
    target_database: Global
    parameters: "()"
    kql_body: |
      // Function: MillCrusher_Current
      let crusher_sensors = dynamic(["MOR-CR03_WI00317_PV", "MOR-CR02_WI01203_PV"]);
      database("Morenci").FCTSCURRENT()
      | where sensor_id in~ (crusher_sensors)
      | extend 
          kpi_name = case(
              sensor_id =~ "MOR-CR03_WI00317_PV", "Crusher_Rate_TPH",
              sensor_id =~ "MOR-CR02_WI01203_PV", "Leach_Rate_TPH",
              sensor_id),
          target_min = case(
              sensor_id =~ "MOR-CR03_WI00317_PV", 8500.0,
              sensor_id =~ "MOR-CR02_WI01203_PV", 4500.0, 0.0),
          target_max = case(
              sensor_id =~ "MOR-CR03_WI00317_PV", 9000.0,
              sensor_id =~ "MOR-CR02_WI01203_PV", 6000.0, 0.0)
      | extend 
          current_value = toreal(value),
          status = case(
              toreal(value) >= target_min and toreal(value) <= target_max, "ON_TARGET",
              toreal(value) < target_min, "BELOW_TARGET",
              "ABOVE_TARGET")
      | project kpi_name, current_value, target_min, target_max, status, timestamp

  MiningKPIs_Dashboard:
    priority: HIGH
    description: "Unified dashboard view of all critical KPIs"
    target_database: AppIntegration
    parameters: "()"
    kql_body: |
      // Function: MiningKPIs_Dashboard
      // Combines all critical processing KPIs for dashboard display
      let ios_data = database("Morenci").FCTSCURRENT()
          | where sensor_id in~ ("MOR-CC06_LI00601_PV", "MOR-CC10_LI0102_PV")
          | extend category = "IOS_Level";
      let crusher_data = database("Morenci").FCTSCURRENT()
          | where sensor_id in~ ("MOR-CR03_WI00317_PV", "MOR-CR02_WI01203_PV")
          | extend category = "Crusher_Rate";
      union ios_data, crusher_data
      | extend 
          kpi_name = case(
              sensor_id =~ "MOR-CC06_LI00601_PV", "Main_IOS_Level",
              sensor_id =~ "MOR-CC10_LI0102_PV", "Small_IOS_Level",
              sensor_id =~ "MOR-CR03_WI00317_PV", "Mill_Crusher_Rate",
              sensor_id =~ "MOR-CR02_WI01203_PV", "Crushed_Leach_Rate",
              sensor_id)
      | project category, kpi_name, value = toreal(value), uom, timestamp
      | order by category asc, kpi_name asc

# =============================================================================
# GAP ANALYSIS SUMMARY
# =============================================================================

gap_analysis:
  adx_fully_available:
    description: "KPIs that can be 100% served from ADX"
    count: 8
    kpis:
      - Mill IOS Main Level
      - Mill IOS Small Level
      - Mill Crusher Rate
      - Crushed Leach Rate
      - Ball Mill TPH (32 mills)
      - Mill Power
      - Classifier pH
      - Bin Levels
      
  snowflake_only:
    description: "KPIs that require Snowflake (no ADX path)"
    count: 5
    kpis:
      - Drill Penetration Rate
      - Drill Cycle Time
      - LBS on Ground (Blasting)
      - Powder Factor
      - Haulage Cycle Time
    reason: "Fleet dispatch and computed metrics not in ADX"
    
  hybrid_partial:
    description: "KPIs with partial ADX coverage"
    count: 2
    kpis:
      - Equipment Hours (via SAP integration)
      - Fuel Consumption (via SAP integration)
    note: "Available in HaulTruck() function but limited scope"

# =============================================================================
# IMPLEMENTATION ROADMAP
# =============================================================================

implementation_roadmap:
  phase_1:
    name: "Mill IOS Dashboard"
    priority: HIGHEST
    timeframe: "Week 1-2"
    tasks:
      - Create MillIOS_Current() function
      - Build ADX dashboard for IOS levels + direction
      - Configure alerts for rapid changes (>5% in 15 min)
      - Test integration with existing workflows
      
  phase_2:
    name: "Processing Metrics Dashboard"
    priority: HIGH
    timeframe: "Week 2-3"
    tasks:
      - Leverage existing Morenci_Batman_* functions
      - Add target thresholds to crusher queries
      - Build section-by-section monitoring
      - Create MillCrusher_Current() function
      
  phase_3:
    name: "Unified Mining Dashboard"
    priority: MEDIUM
    timeframe: "Week 3-4"
    tasks:
      - Create MiningKPIs_Dashboard() function
      - ADX for sensor data (IOS, crusher, mills)
      - Federated view with Snowflake for computed metrics
      - Drill/Blast/Haul metrics from Snowflake API
      
  phase_4:
    name: "Full Integration"
    priority: LOWER
    timeframe: "Week 4+"
    tasks:
      - Evaluate fleet dispatch integration to ADX
      - Consider IoT sensors for drilling equipment
      - Unified API layer for all KPIs

# =============================================================================
# RELATED DOCUMENTATION
# =============================================================================

related_files:
  knowledge_base: "../knowledge_base.json"
  kpi_mapping_analysis: "../KPI_ADX_MAPPING_ANALYSIS.md"
  database_snapshots: "../adx_snapshots/"
  individual_semantic_models:
    - Morenci.semantic.yaml
    - Global.semantic.yaml
    - AppIntegration.semantic.yaml
    - Miami.semantic.yaml
    - Bagdad.semantic.yaml
    - Climax.semantic.yaml
    - Sierrita.semantic.yaml
    - NewMexico.semantic.yaml
    - CerroVerde.semantic.yaml
